#!/usr/bin/env bash

set -e

function cleanup() {
  kdestroy
}

trap cleanup EXIT

date --iso-8601=ns
echo "$PW" | kinit {{ pillar['sssd-ipa']['principal'] }}
date --iso-8601=ns
echo "Done with kinit"

set -x


HOSTNAME=$(hostname)
FQDN=$(hostname -f)
IPADDR=$(hostname -i)
REVERSE_IP=$(hostname -i | awk -F. '{print $4"."$3"." $2"."$1}')

# add dns a-record 3 times with a 10 seconds interval (see CDPSDX-1981, CB-13379)
for attempt in {1..3}
do
  echo "add dns a-record hostname for ${HOSTNAME}, attempt ${attempt}"
  IPA_STDERR=$(mktemp)
  retVal=0
  alreadyExists=0

  date --iso-8601=ns
  if [[ "$attempt" -eq 1 ]]; then
    echo "Attempt1: Attempting dnsrecord-mod with -f flag"
    ipa -v -f  dnsrecord-mod {{ pillar['sssd-ipa']['domain'] }}. "${HOSTNAME}" "--a-rec=${IPADDR}" --ttl {{ pillar['sssd-ipa']['dns_ttl'] }} 2>"${IPA_STDERR}" || retVal=$?
  else
    echo "Attempting dnsrecord-mod without -f flag"
    ipa -v dnsrecord-mod {{ pillar['sssd-ipa']['domain'] }}. "${HOSTNAME}" "--a-rec=${IPADDR}" --ttl {{ pillar['sssd-ipa']['dns_ttl'] }} 2>"${IPA_STDERR}" || retVal=$?
  fi
  date --iso-8601=ns

  cat "${IPA_STDERR}" >&2
  if grep "ERROR: no modifications to be performed" ${IPA_STDERR} &>/dev/null; then
    alreadyExists=1
    echo "DNS a-record already exists for ${HOSTNAME}"
  fi
  rm "${IPA_STDERR}"
  if [[ "$retVal" -eq 0 || ( "$retVal" -eq 1 && "$alreadyExists" -eq 1 ) ]]; then
    break
  elif [[ "$attempt" -eq 3 ]]; then
    echo "Failed to set DNS A-record for ${HOSTNAME}"
    false
  else
    echo "Sleeping for 10 seconds before next dns-mod attempt"
    sleep 10
  fi
done

# TODO: Redo some of this logic. 1. Zone discovery. 2. Multiple attempts, especially - send the first attempt to the default.
date --iso-8601=ns
echo "Setting reverse pointer"
for zone in $(ipa -v dnszone-find --raw | grep "idnsname:.*\.in-addr\.arpa\." | cut -d':' -f2 | awk '{ print length, $0 }' | sort -n -r | awk '{ print $2 }' | xargs)
do
    date --iso-8601=ns
    ZONE_NET=${zone//.in-addr.arpa./}
    if echo "$REVERSE_IP" | grep -qE "\.$ZONE_NET$"; then
        REVERSE_RECORD_NAME=$(echo "$REVERSE_IP" | sed "s/\.$ZONE_NET$//g")
        # dnsrecord-add must either add the record or modify it
        date --iso-8601=ns
        if ! ipa -v -f dnsrecord-find "$zone" "--name=$REVERSE_RECORD_NAME" "--ptr-rec=${FQDN}." --ttl {{ pillar['sssd-ipa']['dns_ttl'] }}; then
          ipa -v -f dnsrecord-add "$zone" "$REVERSE_RECORD_NAME" "--ptr-rec=${FQDN}." --ttl {{ pillar['sssd-ipa']['dns_ttl'] }}
        fi
        date --iso-8601=ns
        if ipa -v -f dnsrecord-find "$zone" "--name=$REVERSE_RECORD_NAME" "--ptr-rec=${FQDN}." --ttl {{ pillar['sssd-ipa']['dns_ttl'] }}; then
          date --iso-8601=ns
          break
        else
          date --iso-8601=ns
          echo "Failed to set Reverse DNS PTR-record for ${FQDN}"
          false
        fi
    fi
done
date --iso-8601=ns

set +x
set +e
